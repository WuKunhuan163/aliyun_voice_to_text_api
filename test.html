<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿里云语音识别测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .log-area {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .result-area {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            min-height: 50px;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .info {
            color: blue;
        }
    </style>
</head>
<body>
    <h1>阿里云语音识别测试页面</h1>
    
    <div class="form-group">
        <label for="appKey">AppKey:</label>
        <input type="text" id="appKey" placeholder="输入您的AppKey">
    </div>
    
    <div class="form-group">
        <label for="accessKeyId">Access Key ID:</label>
        <input type="text" id="accessKeyId" placeholder="输入您的Access Key ID">
    </div>
    
    <div class="form-group">
        <label for="accessKeySecret">Access Key Secret:</label>
        <input type="password" id="accessKeySecret" placeholder="输入您的Access Key Secret">
    </div>
    
    <div class="form-group">
        <button id="testTokenBtn">测试Token获取</button>
        <button id="recordBtn" disabled>开始录音</button>
        <button id="stopBtn" disabled>停止录音</button>
        <button id="testFileBtn">测试文件上传识别</button>
    </div>
    
    <div class="form-group">
        <label>调试日志:</label>
        <div id="logArea" class="log-area"></div>
    </div>
    
    <div class="form-group">
        <label>识别结果:</label>
        <div id="resultArea" class="result-area">等待识别结果...</div>
    </div>
    
    <input type="file" id="fileInput" accept="audio/*" style="display: none;">

    <script>
        class VoiceRecognitionTest {
            constructor() {
                this.initElements();
                this.setupEventListeners();
                this.audioChunks = [];
                this.mediaRecorder = null;
                this.currentToken = null;
                this.apiUrl = '/api/recognize';
            }
            
            initElements() {
                this.appKey = document.getElementById('appKey');
                this.accessKeyId = document.getElementById('accessKeyId');
                this.accessKeySecret = document.getElementById('accessKeySecret');
                this.testTokenBtn = document.getElementById('testTokenBtn');
                this.recordBtn = document.getElementById('recordBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.testFileBtn = document.getElementById('testFileBtn');
                this.logArea = document.getElementById('logArea');
                this.resultArea = document.getElementById('resultArea');
                this.fileInput = document.getElementById('fileInput');
            }
            
            setupEventListeners() {
                this.testTokenBtn.addEventListener('click', () => this.testTokenAPI());
                this.recordBtn.addEventListener('click', () => this.startRecording());
                this.stopBtn.addEventListener('click', () => this.stopRecording());
                this.testFileBtn.addEventListener('click', () => this.testFileUpload());
                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
                const logEntry = `[${timestamp}] ${message}\n`;
                
                const span = document.createElement('span');
                span.className = className;
                span.textContent = logEntry;
                
                this.logArea.appendChild(span);
                this.logArea.scrollTop = this.logArea.scrollHeight;
                
                console.log(`[${type.toUpperCase()}]`, message);
            }
            
            clearLog() {
                this.logArea.innerHTML = '';
            }
            
            async testTokenAPI() {
                this.clearLog();
                this.log('🔄 开始测试Token API...');
                
                const appKey = this.appKey.value.trim();
                const accessKeyId = this.accessKeyId.value.trim();
                const accessKeySecret = this.accessKeySecret.value.trim();
                
                if (!appKey || !accessKeyId || !accessKeySecret) {
                    this.log('❌ 请填写所有必需字段', 'error');
                    return;
                }
                
                try {
                    this.log('📤 发送Token请求...');
                    this.log(`   AppKey: ${appKey}`);
                    this.log(`   AccessKeyId: ${accessKeyId.substring(0, 8)}...`);
                    this.log(`   AccessKeySecret: ${accessKeySecret.substring(0, 8)}...`);
                    
                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            audioData: [], // 空音频数据，只测试Token
                            appKey: appKey,
                            accessKeyId: accessKeyId,
                            accessKeySecret: accessKeySecret
                        })
                    });
                    
                    this.log(`📡 HTTP响应状态: ${response.status}`);
                    
                    const result = await response.json();
                    this.log('📄 API响应:', JSON.stringify(result, null, 2));
                    
                    if (result.success) {
                        this.log('✅ Token获取成功!', 'success');
                        this.currentToken = result.data.tokenExpireTime;
                        this.recordBtn.disabled = false;
                    } else {
                        this.log(`❌ Token获取失败: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    this.log(`❌ 请求失败: ${error.message}`, 'error');
                }
            }
            
            async startRecording() {
                this.log('🎤 开始录音...');
                this.audioChunks = [];
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });
                    
                    this.log('✅ 获取麦克风权限成功');
                    
                    this.mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                            this.log(`📊 音频数据块: ${event.data.size} bytes`);
                        }
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        this.log('⏹️ 录音停止，开始处理...');
                        this.processRecording();
                    };
                    
                    this.mediaRecorder.start(1000); // 每秒收集一次数据
                    this.recordBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    
                    this.log('🔴 录音开始...');
                    
                } catch (error) {
                    this.log(`❌ 录音失败: ${error.message}`, 'error');
                }
            }
            
            stopRecording() {
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                    this.recordBtn.disabled = false;
                    this.stopBtn.disabled = true;
                    this.log('⏸️ 停止录音...');
                }
            }
            
            async processRecording() {
                try {
                    const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                    this.log(`📁 音频文件大小: ${audioBlob.size} bytes`);
                    this.log(`📁 音频类型: ${audioBlob.type}`);
                    
                    // 转换为字节数组
                    const arrayBuffer = await this.blobToArrayBuffer(audioBlob);
                    const audioByteArray = Array.from(new Uint8Array(arrayBuffer));
                    
                    this.log(`🔄 转换为字节数组: ${audioByteArray.length} bytes`);
                    this.log(`📊 前10个字节: [${audioByteArray.slice(0, 10).join(', ')}]`);
                    
                    await this.recognizeAudio(audioByteArray);
                    
                } catch (error) {
                    this.log(`❌ 音频处理失败: ${error.message}`, 'error');
                }
            }
            
            async blobToArrayBuffer(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(blob);
                });
            }
            
            async recognizeAudio(audioByteArray) {
                try {
                    this.log('🚀 开始语音识别...');
                    this.resultArea.textContent = '识别中...';
                    
                    const requestBody = {
                        audioData: audioByteArray,
                        appKey: this.appKey.value.trim(),
                        accessKeyId: this.accessKeyId.value.trim(),
                        accessKeySecret: this.accessKeySecret.value.trim(),
                        format: 'pcm',
                        sampleRate: 16000
                    };
                    
                    this.log(`📤 发送识别请求: ${audioByteArray.length} bytes`);
                    
                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    this.log(`📡 识别响应状态: ${response.status}`);
                    
                    const result = await response.json();
                    this.log('📄 识别结果:', JSON.stringify(result, null, 2));
                    
                    if (result.success && result.data && result.data.text) {
                        this.log(`✅ 识别成功: "${result.data.text}"`, 'success');
                        this.resultArea.innerHTML = `<strong>识别结果:</strong> ${result.data.text}`;
                    } else {
                        this.log(`❌ 识别失败: ${result.error || '未知错误'}`, 'error');
                        this.resultArea.innerHTML = `<strong>识别失败:</strong> ${result.error || '未知错误'}`;
                    }
                    
                } catch (error) {
                    this.log(`❌ 识别请求失败: ${error.message}`, 'error');
                    this.resultArea.innerHTML = `<strong>请求失败:</strong> ${error.message}`;
                }
            }
            
            testFileUpload() {
                this.fileInput.click();
            }
            
            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                this.log(`📁 选择文件: ${file.name} (${file.size} bytes, ${file.type})`);
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const audioByteArray = Array.from(new Uint8Array(arrayBuffer));
                    
                    this.log(`🔄 文件转换为字节数组: ${audioByteArray.length} bytes`);
                    
                    await this.recognizeAudio(audioByteArray);
                    
                } catch (error) {
                    this.log(`❌ 文件处理失败: ${error.message}`, 'error');
                }
            }
        }
        
        // 初始化测试工具
        const tester = new VoiceRecognitionTest();
        
        // 页面加载完成后显示说明
        window.addEventListener('load', () => {
            tester.log('🌟 阿里云语音识别测试工具已加载');
            tester.log('📝 使用说明:');
            tester.log('   1. 填写AppKey和AccessKey信息');
            tester.log('   2. 点击"测试Token获取"验证配置');
            tester.log('   3. 点击"开始录音"进行语音识别测试');
            tester.log('   4. 或点击"测试文件上传识别"上传音频文件测试');
            tester.log('');
        });
    </script>
</body>
</html>
